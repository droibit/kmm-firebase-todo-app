rules_version = '2';
service cloud.firestore {

  match /databases/{database}/documents {

    match /users/{userId} {
      allow read: if isUserAuthenticated(); 

      match /tasks/{taskId} {
        allow read: if isUserAuthenticated();
        allow create: if isUserAuthenticated()
                      && isValidTaskScheme(incomingData())
                      && canCreateTask(incomingData());
        allow update: if isUserAuthenticated()
                      && isValidTaskScheme(incomingData())
                      && canUpdateTask(incomingData(), existingData());

        function isValidTaskScheme(task) {
          return task.size() == 4 
            && 'title' in task && task.title is string
            && 'description' in task && task.description is string
            && 'completed' in task && task.completed is bool
            && 'createdAt' in task && task.createdAt is timestamp;
        }

        function canCreateTask(task) {
          return hasSize(task.title, 1, 100)
            && hasSize(task.description, 0, 500)
            && task.completed == false
            && task.createdAt == request.time;
        }

        function canUpdateTask(newTask, oldTask) {
          return hasSize(newTask.title, 1, 100)
            && hasSize(newTask.description, 0, 500)
            && newTask.createdAt == oldTask.createdAt;
        }
      }

      function isUserAuthenticated() {
        return isAuthenticated() && request.auth.uid == userId;
      }
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    function existingData() {
      return resource.data;
    }
    function incomingData() {
      return request.resource.data;
    }

    function isStringOrNull(value) {
      return value is string || value == null;
    }

    function hasSize(value, min, max) {
      return min <= value.size() && value.size() <= max;
    }

    function hasSizeOrNull(value, min, max) {
      return (value == null || hasSize(value, min, max));
    }    
  }
}
